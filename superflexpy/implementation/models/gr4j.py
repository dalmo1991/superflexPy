"""
Copyright 2020 Marco Dal Molin et al.

This file is part of SuperflexPy.

SuperflexPy is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

SuperflexPy is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with SuperflexPy. If not, see <https://www.gnu.org/licenses/>.

This file is part of the SuperflexPy modelling framework. For details about it,
visit the page https://superflexpy.readthedocs.io

CODED BY: Marco Dal Molin
DESIGNED BY: Marco Dal Molin, Fabrizio Fenicia, Dmitri Kavetski

This file implements a version of the model GR4J
"""

from superflexpy.framework.unit import Unit
from superflexpy.implementation.elements.gr4j import (
    FluxAggregator,
    InterceptionFilter,
    ProductionStore,
    RoutingStore,
    UnitHydrograph1,
    UnitHydrograph2,
)
from superflexpy.implementation.elements.structure_elements import (
    Junction,
    Splitter,
    Transparent,
)
from superflexpy.implementation.numerical_approximators.implicit_euler import (
    ImplicitEulerPython,
)
from superflexpy.implementation.root_finders.pegasus import PegasusPython

x1, x2, x3, x4 = (50.0, 0.1, 20.0, 3.5)

root_finder = PegasusPython()  # Use the default parameters
numerical_approximation = ImplicitEulerPython(root_finder)

interception_filter = InterceptionFilter(id="ir")

production_store = ProductionStore(
    parameters={"x1": x1, "alpha": 2.0, "beta": 5.0, "ni": 4 / 9},
    states={"S0": 10.0},
    approximation=numerical_approximation,
    id="ps",
)

splitter = Splitter(weight=[[0.9], [0.1]], direction=[[0], [0]], id="spl")

unit_hydrograph_1 = UnitHydrograph1(parameters={"lag-time": x4}, states={"lag": None}, id="uh1")

unit_hydrograph_2 = UnitHydrograph2(parameters={"lag-time": 2 * x4}, states={"lag": None}, id="uh2")

routing_store = RoutingStore(
    parameters={"x2": x2, "x3": x3, "gamma": 5.0, "omega": 3.5},
    states={"S0": 10.0},
    approximation=numerical_approximation,
    id="rs",
)

transparent = Transparent(id="tr")

junction = Junction(
    direction=[[0, None], [1, None], [None, 0]], id="jun"  # First output  # Second output  # Third output
)

flux_aggregator = FluxAggregator(id="fa")

model = Unit(
    layers=[
        [interception_filter],
        [production_store],
        [splitter],
        [unit_hydrograph_1, unit_hydrograph_2],
        [routing_store, transparent],
        [junction],
        [flux_aggregator],
    ],
    id="model",
)
